

# MySQL

UDTS支持MySQL作为数据传输源/目标，支持版本有 MySQL(包含Percona版)5.5/5.6/5.7/8.0; MariaDB 10.1.2 及以上，以及PolarDB(MySQL兼容版本)。

## 功能限制
### 参数

如里全量迁移以后还要进行增量迁移，要求源数据库开启binlog, 格式设置为ROW, image设置为FULL

```
binlog_format    为 ROW
binlog_row_image 为 FULL
```

查询方式：
```
show global variables like 'binlog_format';
show global variables like 'binlog_row_image'；
```

设置方式：
```
set global binlog_format = "ROW" ;
set global binlog_row_image = "FULL" ;
```

### MyISAM 引擎表

UDTS 支持 MyISAM 引擎表的全量迁移及增量同步，但是有以下限制：
* 导出数据时会锁MyISAM表(读不受影响)，直到全表数据导出。可能会影响业务。
* 不支持一条事务中同时更新MyISAM引擎表和InnoDB引擎表。
* 对于损坏的表，在迁移之前要进行修复。

建议用户将MyISAM 引擎表转换为InnoDB引擎表以后再使用UDTS迁移。

### 数据量

建议单个全量迁移任务所迁移的数据量不超过200G， 最大支持500G。 如果所要迁移的数据量超过了500G，可以将任务拆分为多个任务进行迁移。 UDTS 提供按库、按表、按多库、按多表等多维度的迁移方式。 

如果迁移任务超过了500G， 且无法拆分为多个任务， 请联系技术支持。

### 权限

默认配置迁移需要账号拥有super权限（UDB获取super权限方法详见FAQ）。 如果没有super权限，请选择“NoLocks” 模式。 在“NoLocks” 模式下，需要所有表都有显式主键或者唯一键，否则增量同步过程中可能产生重复数据。

### 其它限制
- 数据库名与表名中不能包含点(.)字符。
- 全量迁移阶段， 空数据库不迁移。
- 不迁移除test以外的内置数据库。
- 增量阶段暂时不支持视图、存储过程、自定义函数、触发器。
- 全量阶段暂时不支持触发器。
- 增量同步开启之前，需要关闭event.
- 如果源是阿里云 MySQL RDS, 所有表必须要有显式主键， 否则增量同步功能不支持。

## 注意事项
### 存储空间

迁移的过程中可能会在目标数据库产生slow log, 其存储于mysql数据库中。 所以迁移结束以后目标数据库占用的存储空间可能会大于源数据库占用的存储空间。 建议使用UDTS迁移数据库的过程中关闭目标数据库的slow log， 迁移结束以后重新开启 slow log。 在迁移较大的数据库时， 产生的slow log可能会很大， 如果迁移的过程中没有关闭slow log, 请预留好slow log的存储空间。 

如果迁移目标MySQL数据库开启了Binlog， 目标数据库产生的 Binlog 会占用存储空间。 当数据量较大时（超过200G）， 建议用户打开 NoBinlog 选项，这样在全量迁移的过程中在目标数据库不会产生Binlog，减少迁移对磁盘的额外需求。 也可加快全量迁移速度， 缩短进程。 如果在迁移的过程中一定要开启Binlog， 请为目标数据库创建较大的存储空间或者定时清理不需要的Binlog文件， 以免存储空间不够导致任务失败（根据经验，迁移3TB的数据会产生3TB以上的Binlog文件， 即源数据库存储空间为3TB， 目标需要6TB存储空间）。

### 主从切换

如果源MySQL数据库是主从结构，当主从发生切换时，对UDTS产生的影响如下：
- 发生在全量迁移阶段，全量迁移失败，需要重启任务。
- 发生的增量同步阶段，如果使用GTID同步，则无影响；如果没有使用GTID同步， 则同步失败， 需要重新做全+增。

## MySQL填写表单

| 参数名   | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 地址类型  | 支持内网地址，外网地址，专线地址三种方式。内网地址需要填写VPC和子网信息；外网地址支持IP和域名两种方式；专线地址既支持IP，也支持域名，如果使用域名需要用户网络有外网出口。  |
| 端口     | MySQL连接端口                                                |
| 用户名   | MySQL连接用户名                                              |
| 密码     | MySQL数据库对应用户密码                                      |
| 数据库名 | MySQL数据库名称。 所有库传输请填写*； 指定一个数据库传输，请填写数据库名；指定多个数据库传输，依次输入多个数据库名，库名之间使用英文逗号隔开。|                                         |
| 表名     | MySQL传输表名。 只有当“数据库名”为指定一个数据库时有效。 若不填，默认为迁移指定库中的所有表； 指定一张表传输， 请填写表名； 指定多张表传输，依次输入多张表名，表名之间使用英文逗号隔开 |
| Nolocks     | 默认关闭，对于无法获取super权限的友商RDS服务需要开启，UDB获取super权限详见FAQ                  |
| 最大速率    | 外网/专线的速率范围为1-56 MB/s，默认56 MBps (即448 Mbps); 内网的速率范围为 1-1024 MB/s，默认64 MBps(即512Mbps). 源目皆可设置速率。 如果不了解如何设置， 请参考建议速率配置表          |
| NoBinlog   | 当数据源和目标都是MySQL时，在全量阶段可以设置关闭目标端binlog文件的写入，默认不关闭    |

### 建议速率配置表

源限速配置参考值

| 数据库可用内存大小 (G) | 内网建议值 (MB/s) | 外网/专线建议值 (MB/s) |
| ------------------ | ---------- | --------------- |
| (0, 2)            | 10       | 10            |
| [2, 4)           | 15       | 15            |
| [4, 6)           | 20       | 20            |
| [6, 8)           | 30       | 30            |
| [8, 10)          | 40       | 40            |
| [10, 20)         | 50       | 50            |
| [20, 40)         | 60       | 56            |
| [40, 60)         | 70       | 56            |
| [60, 80)         | 80       | 56            |
| [80, 100)        | 90       | 56            |
| >=100             | 100      | 56            |


目标限速配置参考值

| 数据库可用内存大小 (G) | 内网建议值 (MB/s) | 
| ------------------ | ---------- | 
| (0, 1)            | 1       |
| [1, 2)            | 2        | 
| [2, 4)           | 5        |
| [4, 6)           | 10       |
| [6, 8)           | 20       |
| [8, 10)          | 30       |
| [10, 20)         | 50       |
| [20, 40)         | 60       |
| [40, 60)         | 70       |
| [60, 80)         | 80       |
| [80, 100)        | 90       |
| >=100             | 100      |
