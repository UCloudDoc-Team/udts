# 使用UDTS迁移之后业务切换流程说明

当您的DTS实例成功将数据同步或迁移至目标库后，可参考本文进行业务切换，以最大程度减少迁移对业务的影响。本文以迁移实例为例，介绍业务切换的相关步骤。

## 前提条件

- 已配置数据迁移实例，且数据迁移实例处于运行中或已完成状态。
- 配置方法请参见迁移方案概览。

## 方案概览

1. **暂停源库的业务写入**  
   暂时中断业务，禁止新的数据写入源库，避免数据丢失。
2. **暂停迁移实例**  
   源库的数据写入到目标库后，暂停迁移实例。
3. **创建反向数据迁移实例并启动**  
   将目标库产生的增量数据实时迁移回源库，为业务提供回退方案。业务切换后如有异常，可切回源库。
4. **切换业务**  
   切换业务写入的数据库，并恢复业务。

## 注意事项

> - 业务切换操作需停止数据库写入并暂停业务，请选择业务低峰期操作以降低影响。
> - 暂停迁移实例超过7天将无法恢复运行。
> - 任务如不再使用，请手动取消自动续费或释放实例，避免产生额外费用。

## 操作步骤

### 业务切换

1. **等待迁移任务进入增量迁移阶段，任务状态为 “同步中” 或 “已同步” 且剩余数据量小于5MB。**
   
   ![](http://udts-doc.cn-bj.ufileos.com/practice/switch/status.png)

   > **说明**  
   > 若迁移实例没有增量迁移阶段（购买时选择的是全量任务），则数据迁移完成后会自动结束任务，请等待实例状态变为已完成。

2. **将业务暂时中断，禁止在源库中写入新数据。**

3. **登录源库查看会话信息，确保没有新的会话执行写入操作。**

   常见数据库查看会话信息命令：

   - MySQL:  
     ```
     show processlist;
     ```
   - SQL Server / Oracle / PostgreSQL / Redis / MongoDB:  
     参考各自数据库命令

   > **说明**  
   > 查询到的进程或会话信息中，包含UDTS连接源库的进程或会话。

4. **暂停迁移实例。**

   > **注意**  
   > - 迁移任务暂停期间请勿随意启动，否则可能导致数据不一致。  
   > - 若迁移任务没有增量迁移阶段，则无需执行此操作。

   - 等待迁移任务状态变为"已同步"，或者剩余数据量小于5MB。
     > **说明**  
     > 任务状态为“已同步”或剩余数据量为0可能是短暂状态，此时源库待迁移数据已成功迁移至目标库。
   - 继续等待1~3分钟。
   - 在迁移任务操作列选择“暂停任务”，在弹出提醒对话框中单击“确定”，等待实例状态变为“已暂停”。

5. **创建反向数据迁移实例。**

   - 保持业务中断状态。
   - 取消源库禁止写入的限制。
   - 创建反向数据迁移实例并启动（需创建单增量任务）。
   - 等待实例状态变为“运行中”。

6. **切换业务。**

   - 将业务切换为目标库。
   - 恢复业务数据写入。
   - 测试业务功能。

### 回滚方案

> **说明**  
> 业务切换失败等异常情况下，可参考该方案恢复业务。

1. 将业务暂时中断，禁止在数据库中写入新数据。
2. 将业务切换回源库。
3. 恢复业务数据写入。
4. 暂停反向同步任务。

## 后续操作

业务切换至目标库并稳定运行一段时间，测试所有业务涉及的功能并确认无问题后，可结束反向数据迁移实例。