

# MySQL双向同步

为满足用户多地域甚至跨云容灾等需求，UDTS推出了MySQL-MySQL双向同步的功能。

双向同步的基本要求与单向同步完全相同，具体信息请参考[数据迁移说明](/udts/type/mysql_source/mysql2mysql)

一组双向同步任务由一个从源库同步到目标库的正向主任务，和一个从目标库同步到源库的反向子任务组成。
正反任务可以单独启动/停止，不可单独删除，计费统一关联于正向主任务。

## 创建双向同步任务

- 任务设置

`同步类型` 选择 `双向同步`

分别填写`数据源`和`传输目标`的具体信息

![](http://udts-doc.cn-bj.ufileos.com/create-bi1.png)

- 双向同步设置
    - 是否需要全量同步：如果源库和目标库数据不一致，请选择“ON”，创建任务后，启动正向任务时，会将数据源库中指定库表/整库的全量数据一次性传输到目标端
    - 全量完成后是否自动启动反向任务：如果选择“ON”，正向任务启动并完整全量同步、进入增量同步后，反向任务会自动启动。正向任务执行全量同步期间，反向任务的状态为“等待中”，此时反向任务不可启动。
    - NoLocks：默认配置全量迁移需要源数据库账号拥有 SUPER 权限，如果没有 SUPER 权限，请选择 "NoLocks" 模式。
    - NoBinlog：默认配置全量迁移会在目标库生成binlog，占用目标库存储空间。开启 "NoBinlog" 模式需要目标库的 SUPER 权限，开启后全量迁移任务不会在目标库生成binlog。
    - 是否开启DDL同步：开启后正向任务可以同步DDL，无论是否开启，反向任务均不支持DDL同步。
    - 数据冲突解决方式：用于选择数据发生冲突时所采取的处理方式。如果选择替换，则会使用replace into将原有数据替换为新数据；如果选择忽略，则保留原有数据，忽略新数据。正向任务和反向任务可以分别选择不同的数据冲突解决方式。

![](http://udts-doc.cn-bj.ufileos.com/create-bi2.png)

## 注意事项

1. 双库需要开启binlog, 格式为ROW, MODE 为FULL，开启GTID模式。
2. 库内的表必须都要有主键。
3. 双向同步的两个表如果是主键自增，需要两边设置对应的自增步进值，比如一边使用奇数 ID，一边使用偶数 ID，这样数据记录创建时，不会出现同样 ID 的数据，或者使用UUID/snowflake，来确保两表的ID不会重复。
4. 因为同步可能会受到网络、锁等因素造成延迟，为保障同步数据的一致性，您需要确保同一个主键的记录只在双向同步的一个节点进行更新。
5. 数据同步时，请勿对源库的同步对象使用gh-ost或pt-online-schema-change等类似工具执行在线DDL变更，否则会导致同步失败。
6. 源库和目标库需要保持版本一致。
7. 双向同步任务运行时，dts 会在源库和目标库中创建名为 `syncer_meta_schema` 的数据库，任务运行期间，请勿修改或删除此库。